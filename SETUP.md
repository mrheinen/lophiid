# Lophiid Setup Guide

Lophiid is a distributed honeypot system with a centralized backend and remote agents. This guide covers Docker-based deployment.

## Prerequisites

- Docker and Docker Compose installed
- User added to docker group: `sudo usermod -aG docker $USER` (restart session after)
- At least 8GB RAM available for Docker builds (Yara-X compilation is memory intensive)

## Architecture Overview

### Backend Infrastructure (One Server)
- **Backend**: gRPC server on port 8080 (for agent connections)
- **API**: REST API on port 9999 (for UI)
- **UI**: Web interface on port 9888
- **PostgreSQL**: Database on port 5432

### Remote Agents (Multiple Honeypot Machines)
- **HTTP Honeypot**: Ports 80, 8000, 8001, 8002
- **HTTPS Honeypot**: Ports 443, 981, 1311, 8243, 8333, 8443, 8448, 8843
- **gRPC Client**: Connects to backend:8080
- **Authentication**: Each agent uses unique 64-character hex auth token

## Deployment Steps

### Development vs Production

**Development Deployment:**
- Uses self-signed certificates
- Suitable for testing and internal networks
- Quick setup with IP addresses

**Production Deployment:**
- Uses Let's Encrypt certificates via Cloudflare DNS
- Requires domain name and Cloudflare API token
- Provides trusted HTTPS certificates for UI, API, and domain-based agents
- Includes nginx reverse proxy for SSL termination
- Automatic HTTP to HTTPS redirect

### Step 1: Generate Backend Certificates

#### Development Setup

For development or testing environments:

```bash
# Generate certificates for your backend server
./scripts/setup-backend-certs.sh <your-server-ip>

# Example:
./scripts/setup-backend-certs.sh 8.8.8.8
```

#### Production Setup

For production environments with domain names:

```bash
# First, configure Cloudflare API credentials in .env.backend
nano .env.backend
```

Add these production settings:
```env
# Cloudflare API Configuration (for Let's Encrypt certificates)
CLOUDFLARE_API_TOKEN=your-cloudflare-api-token
LOPHIID_CERT_DOMAIN=your-domain.com
LOPHIID_CERT_EMAIL=your-email@domain.com
```

Then generate certificates with production mode:
```bash
# Generate production certificates with Let's Encrypt
./scripts/setup-backend-certs.sh your-domain.com production

# Example:
./scripts/setup-backend-certs.sh honeypot.mydomain.com production
```

**Cloudflare Setup Requirements:**
1. Domain managed by Cloudflare DNS
2. Cloudflare API token with Zone:Read and Zone:Edit permissions
3. Email address for Let's Encrypt registration

The script creates:
- CA certificate in `certs/ca/ca-cert.pem` (for internal gRPC)
- Server certificates in `certs/server/` (for internal gRPC)
- Let's Encrypt certificates in `certs/live/lophiid-backend/` (for public HTTPS)

**Certificate Usage:**
- **Backend/API HTTPS**: Uses Let's Encrypt certificates via nginx reverse proxy
- **Agent HTTPS honeypots**: Automatically use Let's Encrypt when agent has domain name
- **Internal gRPC**: Uses self-signed certificates (backend ↔ agent communication)

### Step 2: Configure Environment Variables

**CRITICAL**: Edit `.env.backend` before starting services:

```bash
# Edit backend configuration
nano .env.backend
```

**Required changes:**
```env
# Change default passwords
# The API key was previously autogenerated but is now user configurable
POSTGRES_PASSWORD=your-secure-password
LOPHIID_API_KEY=your-secure-api-key

# Update shared database URL with new password (used by all services)
LOPHIID_DATABASE_URL=postgres://lophiid:your-secure-password@postgres:5432/lophiid

# IMPORTANT: Set UI access address (replace with your server IP/domain)
LOPHIID_API_BACKEND_ADDRESS=http://192.168.1.100:9999
```

### Step 3: Start Backend Infrastructure

```bash
# Start all backend services
docker compose up -d

# Verify services are running
docker compose ps
docker compose logs -f backend
```

Access the UI at: `http://your-server-ip:9888`

### Step 4: Generate Agent Deployment Packages

```bash
# Create agent deployment package
./scripts/setup-agent-certs.sh <backend-ip> <agent-ip> [agent-name]

# Examples:
./scripts/setup-agent-certs.sh 192.168.1.100 192.168.1.200 web-server
./scripts/setup-agent-certs.sh backend.mydomain.com 203.0.113.50 honeypot-1
```

This creates a complete deployment package containing:
- **Directory**: `agent-<name>/` with all deployment files
- **Compressed**: `agent-<name>.zip` for easy transfer
- Agent certificates and source code
- `docker-compose.agent.yml` (agent configuration)
- `.env.agent` (environment variables)
- `Dockerfile.agent` and build dependencies

### Step 5: Deploy Remote Agents

**Option A: Using compressed package (recommended)**
```bash
# Copy compressed package to agent machine
scp agent-<name>.zip user@<agent-ip>:~/

# Extract and deploy on agent machine
ssh user@<agent-ip>
unzip agent-<name>.zip
cd agent-<name>/
docker compose -f docker-compose.agent.yml up -d

# Verify agent is running
docker compose -f docker-compose.agent.yml ps
docker compose -f docker-compose.agent.yml logs -f agent
```

**Option B: Copy directory directly**
```bash
# Copy deployment directory to agent machine
scp -r agent-<name>/ user@<agent-ip>:~/

# Deploy on agent machine
ssh user@<agent-ip>
cd agent-<name>/
docker compose -f docker-compose.agent.yml up -d
```

### Step 6: Register Agents in UI

1. Access backend UI at `http://backend-ip:9888`
2. Navigate to **Honeypots** section
3. Click **Add Honeypot**
4. Enter:
   - **IP Address**: The agent machine's public IP
   - **Auth Token**: Found in the agent's `.env.agent` file as `LOPHIID_BACKEND_CLIENT_AUTH_TOKEN`

### Step 7: Verify Deployment

```bash
# Test honeypot response
curl http://<agent-ip>:8000/

# Check backend logs for agent connection
docker compose logs backend | grep "status: updated honeypot"

# View attacks in UI at http://<backend-ip>:9888
```

## Complete Deployment Examples

### Development Example
Complete development setup on local network:
```bash
# 1. Generate development certificates
./scripts/setup-backend-certs.sh 192.168.1.100

# 2. Configure .env.backend (update passwords and UI address)
nano .env.backend
# Update: POSTGRES_PASSWORD, LOPHIID_API_KEY, LOPHIID_DATABASE_URL, LOPHIID_API_BACKEND_ADDRESS

# 3. Start backend
docker compose up -d

# 4. Generate agent package
./scripts/setup-agent-certs.sh 192.168.1.100 192.168.1.101 dev-agent

# 5. Deploy agent (using compressed package)
scp agent-dev-agent.zip user@192.168.1.101:~/
ssh user@192.168.1.101 'unzip agent-dev-agent.zip && cd agent-dev-agent && docker compose -f docker-compose.agent.yml up -d'

# 6. Register agent in UI and verify
```

### Production Example
Complete production setup with domain name:
```bash
# 1. Configure Cloudflare credentials in .env.backend
nano .env.backend
# Add: CLOUDFLARE_API_TOKEN, LOPHIID_CERT_DOMAIN, LOPHIID_CERT_EMAIL

# 2. Generate production certificates with Let's Encrypt
./scripts/setup-backend-certs.sh honeypot.mydomain.com production

# 3. Update .env.backend (passwords, domain-based UI address)
nano .env.backend
# Set: LOPHIID_API_BACKEND_ADDRESS=https://honeypot.mydomain.com

# 4. Start backend infrastructure with production config
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 5. Generate and deploy agents
./scripts/setup-agent-certs.sh honeypot.mydomain.com 203.0.113.50 web-honeypot-1
scp agent-web-honeypot-1.zip user@203.0.113.50:~/
ssh user@203.0.113.50 'unzip agent-web-honeypot-1.zip && cd agent-web-honeypot-1 && docker compose -f docker-compose.agent.yml up -d'

# 6. Register agents in UI with proper domain access
```

## Configuration

### Configuration Files

Lophiid organizes configuration files in the `config/` directory:

- `config/database.sql` - PostgreSQL schema initialization
- `config/nginx.prod.conf` - Production reverse proxy configuration (HTTPS, SSL, API routing)
- `config/nginx.ui.conf` - UI service nginx configuration

### Environment Variables

Lophiid uses environment variables exclusively:

- **Backend**: `.env.backend` - Contains backend, API, UI, and database configuration
- **Agent**: `.env.agent` - Contains agent-specific configuration and auth tokens

**Note**: Docker user mapping (DOCKER_UID/DOCKER_GID) is automatically detected by the setup scripts.

### Certificate Management

The system uses mutual TLS authentication:
- CA certificate validates all communications
- Server certificate for backend gRPC server  
- Client certificates for each agent (unique per agent)

Certificates are automatically generated by the setup scripts.

## Security

- **Mutual TLS**: All backend ↔ agent communication uses client certificates
- **Environment Variables**: No sensitive data in config files
- **Network Isolation**: Agents only need outbound access to backend:8080, consider DMZ placement
- **User Namespace Mapping**: Docker containers run with proper user permissions

## Troubleshooting

### Agent Can't Connect to Backend
1. Check network connectivity: `telnet <backend-ip> 8080`
2. Verify certificates: `openssl x509 -in certs/clients/*.pem -text`
3. Check backend logs: `docker compose logs backend`
4. Verify agent auth token matches UI registration

### UI Not Accessible
1. Verify API is running: `curl http://<backend-ip>:9999/api/health`
2. Check `LOPHIID_API_BACKEND_ADDRESS` in `.env.backend`
3. Ensure UI is accessible: `curl http://<backend-ip>:9888`

### Build Issues
1. **Out of memory during build**: Increase Docker memory limit to 8GB+
2. **Permission issues**: Ensure user is in docker group
3. **Port conflicts**: Check ports 5432, 8080, 9888, 9999 are available

## Optional Features

### VirusTotal Integration
Add to `.env.backend`:
```env
LOPHIID_VIRUSTOTAL_API_KEY=your-virustotal-api-key
```

### Telegram Alerting
Add to `.env.backend`:
```env
LOPHIID_ALERTING_TELEGRAM_API_KEY=your-bot-token
LOPHIID_ALERTING_TELEGRAM_CHAT_ID=your-chat-id
```

### LLM Integration
Add to `.env.backend`:
```env
LOPHIID_AI_TRIAGE_ENABLE=true
LOPHIID_AI_API_LOCATION=http://localhost:8000/v1
LOPHIID_AI_API_KEY=your-api-key
LOPHIID_AI_MODEL=your-model-name
```

## Advanced Usage

### Scaling Multiple Agents
When deploying multiple agents across different machines:
1. Use the same CA certificates (agents are network agnostic)
2. Generate unique auth tokens for each agent (64 hex characters)
3. Register each agent separately in the backend UI
4. Monitor each agent's health through the UI Honeypots section

### Custom Rules
- Create content rules in `rules/` directory as YAML files
- Rules define when/how to respond to requests
- Support static content, JavaScript scripts, and AI-generated responses

### Monitoring
- **Logs**: `docker compose logs -f [service-name]`
- **Health**: All services include health checks
- **Metrics**: Backend exposes Prometheus metrics on `/metrics`
- **Agent Status**: Backend UI Honeypots section shows last check-in times
- **Attack Data**: Monitor UI for incoming attack data from agents

### Updates and Maintenance

To update agents:
```bash
# Pull latest images and restart
docker compose pull
docker compose up -d --force-recreate
```

To rotate certificates:
1. Generate new certificates on backend server
2. Copy new certificates to agent machines  
3. Restart agent containers

### Certificate Verification

To verify your certificate setup:
```bash
# Check certificate configuration
./scripts/verify-certificates.sh
```

This will verify:
- Let's Encrypt certificate presence and validity
- Self-signed certificate configuration
- Production docker-compose setup

## Development Setup

For development or building from source, see the build commands in `CLAUDE.md`:

```bash
# Build protobuf files first
./compile_proto.sh

# Build individual components
bazel build //cmd/backend:backend
bazel build //cmd/agent:client
bazel build //cmd/api:api

# Run tests
bazel test //...
```

## Support

If you encounter any issues, please open an issue on the project repository. The maintainer responds quickly and will help troubleshoot problems.