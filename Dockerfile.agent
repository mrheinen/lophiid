# Multi-stage build for Lophiid Agent
FROM golang:1.24.7-bookworm AS builder

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    libmagic-dev \
    libpcap0.8-dev \
    libssl-dev \
    pkg-config \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Set up workspace
WORKDIR /workspace

# Build p0f
RUN git clone https://github.com/mrheinen/p0f.git
RUN cd p0f && make


# Runtime stage
FROM debian:bookworm-slim

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libmagic1 \
    strace \
    libpcap0.8-dev \
    iputils-ping \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create directories with proper permissions for user namespace mapping
# Note: /var/empty/lophiid is for privilege dropping at runtime
RUN mkdir -p -m 755 /var/empty/lophiid && \
    mkdir -p /app/config /app/certs /app/logs /app/p0f /var/empty/lophiid/ && \
    chmod 755 /app && \
    chmod 777 /app/logs


# Copy binary (correct Bazel output path)
COPY --from=builder /workspace/p0f/p0f /app/p0f/p0f
COPY --from=builder /workspace/p0f/p0f.fp /app/p0f/p0f.fp
COPY ./agent_cli /app/agent_cli
RUN chmod +x /app/agent_cli
RUN chmod +x /app/p0f /app/p0f/p0f

RUN setcap cap_sys_chroot,cap_net_bind_service,cap_setgid,cap_net_raw=+ep /app/p0f/p0f
RUN setcap cap_sys_chroot,cap_net_bind_service,cap_setgid,cap_net_raw=+ep /app/agent_cli

# Note: USER will be set via docker-compose user: directive for namespace mapping

# Set ICMP ping permissions
RUN sysctl -w net.ipv4.ping_group_range="0 2147483647" || echo "ICMP ping setup will be needed at runtime"

# For privileged port binding, run as root
# USER lophiid-agent
WORKDIR /app

# Expose HTTP port (configurable)
EXPOSE 8000

# Health check - test if HTTP server is responding (any HTTP response is good)
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/ | grep -E "^[1-5][0-9][0-9]$" >/dev/null || exit 1

CMD ["/bin/sh", "-c", "cd /app/p0f && ./p0f -s /tmp/p0f.sock > /dev/null 2>&1 & sleep 1; cd /app/config && /app/agent_cli -c agent_config.yaml"]
